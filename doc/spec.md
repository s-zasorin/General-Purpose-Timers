# Спецификация на блок GPT
## Структурная схема 

В состав таймера входят 3 основных блока:  
 1. Time-base unit.  
 2. Slave Mode Controller.  
 3. Канал TIM.

### Time-base unit
Данный блок включает в себя:  
 * Основной счетчик таймера CNT
 * Регистр автоматической перезагрузки (ARR)  
    Данный регистр задает основание счета для счетчика CNT. Счетчик регулярно сравнивает свое значение со значением из ARR. Когда происходит overflow (при счете вверх) или underflow (при счете вниз), генерируется сигнал UEV (Update Event).  
    ARR состоит из двух регистров:  
    * **Preload Register**  — регистр предварительной загрузки. Этот регистр можно настраивать через программный интерфейс. Когда формируется событие UEV, значение из регистра предварительной загрузки помещается в теневой регистр.
    * **Shadow Register** — теневой или активный регистр. Теневой регистр является *внутренним* и недоступен программисту. Именно с теневым регистром происходит сравнение значения счетчика.  
 * Prescaler (PSC) — программно настраиваемый делитель частоты. Служит для деления частоты, тактирующей основной счетчик CNT. Программный регистр делителя, который содержит коэффициент деления, также имеет теневой регистр. Приницп работы такой же, как и для ARR.

#### Режим счета вверх
В этом режиме счетчик считает вверх от 0 до значения в регистре автоматической перезагрузки (ARR). Этот режим включается путем установки бита DIR = 0 в программном регистре TIM_CR1. При переполнении счетчика генерируется событие UEV (Update Event), также выставляется флаг прерывания UIF (Update Interrupting Flag).  
Событие обновления (UEV) может быть отключено путем программной установки значения UDIS в регистре TIMx_CR1. Это позволяет не обновлять теневые регистры во время записи новых значений в регистры предварительной загрузки.
#### Режим счета вниз
В этом режиме счетчик считает от значения в регистре автоматической перезагрузки (ARR) до 0. Этот режим включается путем установки DIR = 1 в регистре TIM_CR1. Когда счетчик досчитывает до 0, генерируется событие «анти переполнения» (underflow).
#### Режим счета вверх-вниз
В этом режиме счетчик считает от 0 до значение TIM_ARR – 1, генерирует событие переполнения счетчика (overflow), затем начинает считать от значения TIM_ARR до 1, после чего генерирует событие «анти переполнения» счетчика (underflow).  
В этом режиме управление направлением счета осуществляется другим способом(поле DIR недоступно для записи). Для управления счетчиком используются биты CMS регистра TIM_CR1.  

Собыие обновление (UEV) может генерироваться:  
 * При каждом **overflow**
 * При каждом **underflow**
 * При установке бита UG в регистре TIM_EGR (программно или с помощью **Slave Mode Controller**)  

Генерацию события можно запретить установив бит UDIS в регистре TIM_CR1.  
Обычно, когда генерируется флаг UIF (Update Interrupt Flag)

### Slave Mode Controller

### Канал TIM

## Сигналы ввода-вывода

## Интерфейсы

## Программная модель
### Управляющий регистр таймера №1 (TIM_CR1)

<img src="/img/TIM_CR1.PNG" width="800" height="200">

 * Биты 15:10 не используются  
 * Биты 9:8 **CKD**: Коэффициент деления частоты цифрового фильтра  
    С помощью этого поля можно управлять формированием отфильтрованного сигнала с частотой $F_{DTS}$,  
    00: $F_{DTS} = F_{INT}$  
    01: $F_{DTS} = \frac{F_{INT}}{2}$  
    10: $F_{DTS} = \frac{F_{INT}}{4}$  
    11: не используется  
 * Бит 7 **APRE**: Разрешение предзагрузки  
    0: Теневой регистр ARR отключен — значение берется напрямую из регистра предварительной загрузки  
    1: Теневой регистр активен  
 * Биты 6:5 **CMS**:  Выбор режима центрового выравнивания  
    00: Счтчик считает **либо** вверх, **либо** вниз, в зависимости от поля **DIR**  
    01: Счетчик считает вверх **и** вниз. Флаг UEV выставляется, когда счетчик считает вниз.  
    10: Счетчик считает вверх **и** вниз. Флаг UEV выставляется, когда счетчик считает вверх.  
    11: Счетчик считает вверх **и** вниз. Флаг UEV выставляется, когда счетчик считает вниз **и** вверх.  
 * Бит 4 **DIR**: Направление счета (вверх/вниз)  
    0: Счетчик считает вверх
    1: Счетчик считает вниз  
 * Бит 3 **OPM**: Режим формирования строба  
    0: Счетчик не останавливается после формирования события обновления (UEV)  
    1: Счетчик останавливается после формирования события обновления (UEV) — бит CEN снимается  
 * Бит 2 **URS**:  

 * Бит 1 **UDIS** Запрет обновления  

 * Бит 0 **CEN** Включения счетчика  
    0: Счетчик остановлен
    1: Счетчик запущен  

### Регистр предделителия TIM_PSC
<img src="img/PSC.PNG" width="1000" height="200">  
Содержит коэффициент деления

### Регистр генерации событий TIM_EGR
<img src="img/TIM_EGR.PNG" width="1000" height="200"> 